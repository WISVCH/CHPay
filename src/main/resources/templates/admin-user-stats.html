<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
      th:with="hasCharts=true">
<head>
    <title>User Balance History</title>
</head>

<body>
    <div layout:fragment="breadcrumbs">
        <div class="breadcrumbs">
            <ul>
                <li>
                    <a href="/admin/users">Users</a>
                </li>
                <li class="breadcrumbs-separator rtl:rotate-180"><span class="icon-[tabler--chevron-right]"></span></li>
                <li>
                    <a th:href="@{/admin/user/{id}(id=${user.getId()})}">User Details</a>
                </li>
                <li class="breadcrumbs-separator rtl:rotate-180"><span class="icon-[tabler--chevron-right]"></span></li>
                <li aria-current="page">Statistics</li>
            </ul>
        </div>
    </div>

    <div layout:fragment="main-content">
        <div class="container max-w-6xl mx-auto">
            <!-- Header Section -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-base-content mb-2">Balance History</h1>
                <p class="text-base-content/70 text-lg">
                    Balance progression for <span th:text="${user.getName()}" class="font-medium">User Name</span>
                </p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Current Balance Card -->
                <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="avatar avatar-placeholder">
                                <div class="bg-primary/20 text-primary size-16 rounded-full">
                                    <span class="icon-[tabler--wallet] size-8"></span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h2 class="card-title text-2xl">Current Balance</h2>
                                <div class="stat-value text-primary text-4xl">
                                    €<span th:text="${#numbers.formatDecimal(user.balance, 1, 2)}">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Count Card -->
                <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="avatar avatar-placeholder">
                                <div class="bg-secondary/20 text-secondary size-16 rounded-full">
                                    <span class="icon-[tabler--receipt] size-8"></span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h2 class="card-title text-2xl">Total Transactions</h2>
                                <div class="stat-value text-secondary text-4xl" th:text="${#lists.size(balanceHistory)}">0</div>
                            </div>
                        </div>
            </div>
        </div>
            </div>

            <!-- Balance Chart Section -->
            <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow mb-8">
                <div class="card-body">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="avatar avatar-placeholder">
                            <div class="bg-secondary/20 text-secondary size-12 rounded-full">
                                <span class="icon-[tabler--chart-line] size-6"></span>
                            </div>
                        </div>
                        <div>
                            <h3 class="card-title text-xl">Balance Progression</h3>
                            <p class="text-base-content/70">Visual representation of balance changes over time</p>
                        </div>
                    </div>
                    
                    <div th:if="${balanceHistory.empty}" class="text-center py-12">
                        <div class="avatar avatar-placeholder mx-auto mb-4">
                            <div class="bg-secondary/20 text-secondary size-16 rounded-full">
                                <span class="icon-[tabler--chart-line] size-8"></span>
                            </div>
                        </div>
                        <h4 class="text-lg font-medium text-base-content/70 mb-2">No Transaction Data</h4>
                        <p class="text-base-content/50">No successful transactions found for this user.</p>
                    </div>
                    
                    <div th:unless="${balanceHistory.empty}" id="balanceChart" class="w-full"></div>
            </div>
            </div>

        </div>
    </div>

    <!-- Chart Script -->
    <th:block layout:fragment="script" th:if="${not balanceHistory.empty}">
        <script th:inline="javascript">
            window.addEventListener('load', () => {
                ;(function () {
                    // Prepare chart data from Thymeleaf
                    const balanceData = /*[[${balanceHistory}]]*/ [];
                    
                    // Transform data for ApexCharts datetime format
                    const chartData = balanceData.map(entry => ({
                        x: new Date(entry.timestamp).getTime(),
                        y: parseFloat(entry.balance)
                    }));
                    
                    // Apex Single Area Chart (Start)
                    buildChart('#balanceChart', () => ({
                        chart: {
                            height: 400,
                            type: 'area',
                            toolbar: {
                                show: false
                            },
                            zoom: {
                                enabled: false
                            }
                        },
                        series: [{
                            name: 'Balance',
                            data: chartData
                        }],
                        legend: {
                            show: false
                        },
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            curve: 'stepline',
                            width: 2
                        },
                        markers: {
                            size: 4,
                            hover: {
                                size: 6
                            }
                        },
                        grid: {
                            strokeDashArray: 2,
                            borderColor: 'color-mix(in oklab, var(--color-base-content) 40%, transparent)'
                        },
                        colors: ['var(--color-success)'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.7,
                                gradientToColors: ['var(--color-success)'],
                                opacityTo: 0.3,
                                stops: [0, 90, 100]
                            }
                        },
                        xaxis: {
                            type: 'datetime',
                            axisBorder: {
                                show: false
                            },
                            axisTicks: {
                                show: false
                            },
                            tooltip: {
                                enabled: false
                            },
                            labels: {
                                style: {
                                    colors: 'var(--color-base-content)',
                                    fontSize: '12px',
                                    fontWeight: 400
                                },
                                datetimeFormatter: {
                                    year: 'yyyy',
                                    month: 'MMM yyyy',
                                    day: 'dd MMM',
                                    hour: 'HH:mm'
                                }
                            }
                        },
                        yaxis: {
                            labels: {
                                align: 'left',
                                minWidth: 0,
                                maxWidth: 140,
                                style: {
                                    colors: 'var(--color-base-content)',
                                    fontSize: '12px',
                                    fontWeight: 400
                                },
                                formatter: value => `€${value.toFixed(2)}`
                            }
                        },
                        tooltip: {
                            x: {
                                format: 'dd MMM yyyy HH:mm'
                            },
                            y: {
                                formatter: value => `€${value.toFixed(2)}`
                            }
                        },
                        responsive: [
                            {
                                breakpoint: 568,
                                options: {
                                    chart: {
                                        height: 300
                                    },
                                    xaxis: {
                                        labels: {
                                            style: {
                                                fontSize: '10px',
                                                colors: 'var(--color-base-content)'
                                            },
                                            datetimeFormatter: {
                                                year: 'yyyy',
                                                month: 'MMM',
                                                day: 'dd',
                                                hour: 'HH:mm'
                                            }
                                        }
                                    },
                                    yaxis: {
                                        labels: {
                                            align: 'left',
                                            minWidth: 0,
                                            maxWidth: 140,
                                            style: {
                                                fontSize: '10px',
                                                colors: 'var(--color-base-content)'
                                            },
                                            formatter: value => `€${value.toFixed(2)}`
                                        }
                                    }
                                }
                            }
                        ]
                    }))
                    // Apex Single Area Chart (End)
                })()
            })
    </script>
    </th:block>
</body>
</html>