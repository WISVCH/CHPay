<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
      th:with="layoutWide=true, hasDataTable=true">
<head>
    <title>Users</title>
</head>

<body>
    <div layout:fragment="main-content">
        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-base-content mb-2">Users</h1>
            <p class="text-base-content/70 text-lg">View and manage users</p>
        </div>

            <!-- DataTable Card -->
            <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow">
                <div class="card-body p-0">
                    <div
                        id="users-datatable"
                        class="flex flex-col"
                        data-datatable='{
                            "pageLength": 25,
                            "paging": true,
                            "searching": true,
                            "ordering": true,
                            "order": [[0, "asc"]],
                            "columnDefs": [
                                {
                                    "targets": [4, 5],
                                    "orderable": false
                                },
                                {
                                    "targets": [5],
                                    "visible": false
                                }
                            ],
                            "pagingOptions": {
                                "pageBtnClasses": "btn btn-text btn-circle btn-sm"
                            },
                            "language": {
                                "zeroRecords": "<div class=\"py-10 px-5 flex flex-col justify-center items-center text-center\"><span class=\"icon-[tabler--search] shrink-0 size-6 text-base-content\"></span><div class=\"max-w-sm mx-auto\"><p class=\"mt-2 text-sm text-base-content/80\">No users found</p></div></div>"
                            }
                        }'
                    >
                        <!-- Search and Controls Header -->
                        <div class="border-base-content/25 flex items-center border-b px-5 py-3 gap-3">
                            <div class="input input-sm max-w-60">
                                <span class="icon-[tabler--search] text-base-content/80 my-auto me-3 size-4 shrink-0"></span>
                                <label class="sr-only" for="users-search"></label>
                                <input type="search" class="grow" placeholder="Search users..." id="users-search" data-datatable-search="" />
                            </div>
                            <div class="flex flex-1 items-center justify-end gap-3">
                                <!-- Select -->
                                <select
                                    data-select='{
                                        "placeholder": "Select option...",
                                        "toggleTag": "<button type=\"button\" aria-expanded=\"false\"></button>",
                                        "toggleClasses": "advance-select-toggle advance-select-sm",
                                        "dropdownClasses": "advance-select-menu w-24 max-sm:w-16",
                                        "optionClasses": "advance-select-option selected:select-active",
                                        "optionTemplate": "<div class=\"flex justify-between items-center w-full\"><span data-title></span><span class=\"icon-[tabler--check] shrink-0 size-3 text-primary hidden selected:block \"></span></div>",
                                        "extraMarkup": "<span class=\"icon-[tabler--caret-up-down] shrink-0 size-4 text-base-content absolute top-1/2 end-2 -translate-y-1/2 \"></span>"
                                    }'
                                    class="hidden"
                                    data-datatable-page-entities=""
                                >
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25" selected="">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <!-- End Select -->
                            </div>
            </div>
                        
                        <div class="w-full overflow-x-auto h-fit">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col" class="group">
                                            <div class="flex items-center justify-between">
                                                Name
                                                <span class="icon-[tabler--chevron-up] hidden datatable-ordering-asc:block"></span>
                                                <span class="icon-[tabler--chevron-down] hidden datatable-ordering-desc:block"></span>
                                            </div>
                                        </th>
                                        <th scope="col" class="group">
                                            <div class="flex items-center justify-between">
                                                Email
                                                <span class="icon-[tabler--chevron-up] hidden datatable-ordering-asc:block"></span>
                                                <span class="icon-[tabler--chevron-down] hidden datatable-ordering-desc:block"></span>
                                            </div>
                                        </th>
                                        <th scope="col" class="group">
                                            <div class="flex items-center justify-between">
                                                OpenID
                                                <span class="icon-[tabler--chevron-up] hidden datatable-ordering-asc:block"></span>
                                                <span class="icon-[tabler--chevron-down] hidden datatable-ordering-desc:block"></span>
                                            </div>
                                        </th>
                                        <th scope="col" class="w-0 group">
                                            <div class="flex items-center justify-between">
                                                Balance
                                                <span class="icon-[tabler--chevron-up] hidden datatable-ordering-asc:block"></span>
                                                <span class="icon-[tabler--chevron-down] hidden datatable-ordering-desc:block"></span>
                                            </div>
                                        </th>
                                        <th scope="col" class="w-0 --exclude-from-ordering">Actions</th>
                                        <th scope="col" class="w-auto --exclude-from-ordering" style="display: none;">User ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user : ${users}">
                                        <!-- Name Column -->
                                        <td th:text="${user.name}">John Doe</td>
                                        
                                        <!-- Email Column -->
                                        <td th:text="${user.email}">john.doe@example.com</td>
                                        
                                        <!-- OpenID Column -->
                                        <td>
                                            <span class="font-mono text-sm" th:text="${user.openID}">user123</span>
                                        </td>
                                        
                                        <!-- Balance Column -->
                                        <td class="w-0 text-right font-mono whitespace-nowrap">
                                            <span class="text-success" 
                                                th:text="'€' + ${#numbers.formatDecimal(user.balance, 1, 2)}">€0.00</span>
                                        </td>
                                        
                                        <!-- Actions Column -->
                                        <td class="w-0 whitespace-nowrap">
                                            <div class="flex items-center gap-1">
                                                <a th:href="@{/admin/user/{id}(id=${user.id})}"
                                                   class="btn btn-circle btn-text btn-sm"
                                                   title="View Details">
                                                    <span class="icon-[tabler--eye] size-5"></span>
                                                </a>
                                                <button 
                                                    type="button" 
                                                    class="btn btn-circle btn-text btn-sm ban-user-btn"
                                                    th:data-user-id="${user.id}"
                                                    th:data-user-name="${user.name}"
                                                    th:data-action="${user.banned} ? 'unban' : 'ban'"
                                                    th:class="${user.banned} ? 'btn btn-circle btn-text btn-sm text-success ban-user-btn' : 'btn btn-circle btn-text btn-sm text-error ban-user-btn'"
                                                    th:title="${user.banned} ? 'Unban User' : 'Ban User'">
                                                    <span th:class="${user.banned} ? 'icon-[tabler--user-check] size-5' : 'icon-[tabler--user-x] size-5'"></span>
                                                </button>
                                            </div>
                                        </td>
                                        
                                        <!-- Hidden User ID Column (for search) -->
                                        <td class="w-auto" style="display: none;" th:text="${user.id}">550e8400-e29b-41d4-a716-446655440000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Footer -->
                        <div class="border-base-content/25 flex items-center justify-between gap-3 border-t p-3 max-md:flex-wrap max-md:justify-center">
                            <div class="text-sm text-base-content/80" data-datatable-info="">
                                Showing
                                <span data-datatable-info-from=""></span>
                                to
                                <span data-datatable-info-to=""></span>
                                of
                                <span data-datatable-info-length=""></span>
                                users
            </div>
                            <div class="flex hidden items-center space-x-1" data-datatable-paging="">
                                <button type="button" class="btn btn-text btn-circle btn-sm" data-datatable-paging-prev="">
                                    <span class="icon-[tabler--chevrons-left] size-4.5 rtl:rotate-180"></span>
                                    <span class="sr-only">Previous</span>
                                </button>
                                <div class="flex items-center space-x-1 [&>.active]:text-bg-soft-primary" data-datatable-paging-pages=""></div>
                                <button type="button" class="btn btn-text btn-circle btn-sm" data-datatable-paging-next="">
                                    <span class="sr-only">Next</span>
                                    <span class="icon-[tabler--chevrons-right] size-4.5 rtl:rotate-180"></span>
                                </button>
                    </div>
                    </div>
                </div>
                </div>
            </div>
    </div>

<!-- Modals -->
<th:block layout:fragment="modals">
    <!-- Hidden trigger for ban confirmation modal -->
    <button type="button" 
            class="hidden" 
            id="ban-confirmation-trigger"
            aria-haspopup="dialog" 
            aria-expanded="false" 
            aria-controls="ban-confirmation-modal" 
            data-overlay="#ban-confirmation-modal">
    </button>

    <!-- Ban/Unban Confirmation Modal -->
    <div id="ban-confirmation-modal" 
         class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden" 
         role="dialog" 
         tabindex="-1">
        <div class="modal-dialog overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="ban-modal-title">Confirm Action</h3>
                    <button type="button" 
                            class="btn btn-text btn-circle btn-sm absolute end-3 top-3" 
                            aria-label="Close" 
                            data-overlay="#ban-confirmation-modal">
                        <span class="icon-[tabler--x] size-4"></span>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="bg-base-200/50 rounded-lg p-4">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-base-content/70">User:</span>
                                <span id="ban-user-name">John Doe</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">Action:</span>
                                <span id="ban-action-text" class="font-semibold">Ban User</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-base-content/70" id="ban-warning-text">
                            Are you sure you want to ban this user? They will no longer be able to make transactions.
                        </p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-soft btn-secondary" data-overlay="#ban-confirmation-modal">Cancel</button>
                    <button type="button" class="btn btn-error" id="confirmBanBtn">
                        <span class="icon-[tabler--user-x] size-4" id="ban-action-icon"></span>
                        <span id="ban-confirm-text">Ban User</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</th:block>

    <!-- Scripts -->
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            // Define global variables needed for user management
            const currentUserId = [[${currentUser.getId()}]];
            const csrfToken = [[${_csrf.token}]];
        </script>
        <script>
            // User management functionality
            window.addEventListener('load', () => {
                setTimeout(() => {
                    // Initialize DataTable
                    const dataTable = $('#users-datatable table').DataTable()

                    // Custom search function for all columns including balance and user ID
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        // Only apply to the users table
                        if (settings.nTable.id !== 'users-datatable') {
                            return true;
                        }
                        
                        const searchTerm = $('#users-search').val().toLowerCase();
                        if (!searchTerm) return true;
                        
                        // Search across all columns: name, email, openID, balance, user ID
                        const name = data[0].toLowerCase();
                        const email = data[1].toLowerCase();
                        const openId = data[2].toLowerCase();
                        const balance = data[3].toLowerCase();
                        const userId = data[5] ? data[5].toLowerCase() : '';
                        
                        return name.includes(searchTerm) || 
                               email.includes(searchTerm) || 
                               openId.includes(searchTerm) ||
                               balance.includes(searchTerm) ||
                               userId.includes(searchTerm);
                    });

                    // Add event listener for search input
                    $('#users-search').on('keyup', function() {
                        dataTable.draw();
                    });

                    // Ban/unban confirmation function
                    function confirmBanAction(button) {
                        const userId = button.getAttribute('data-user-id');
                        const userName = button.getAttribute('data-user-name');
                        const action = button.getAttribute('data-action');

                        if (userId === currentUserId) {
                            triggerNotificationFromData({
                                type: "warning",
                                message: "You cannot ban/unban your own account."
                            });
                            return;
                        }

                        // Update modal content
                        document.getElementById('ban-user-name').textContent = userName;
                        document.getElementById('ban-action-text').textContent = action === 'ban' ? 'Ban User' : 'Unban User';
                        
                        const warningText = action === 'ban' 
                            ? 'Are you sure you want to ban this user? They will no longer be able to make transactions.'
                            : 'Are you sure you want to unban this user? They will be able to make transactions again.';
                        document.getElementById('ban-warning-text').textContent = warningText;
                        
                        // Update button styling and text
                        const confirmBtn = document.getElementById('confirmBanBtn');
                        const actionIcon = document.getElementById('ban-action-icon');
                        const confirmText = document.getElementById('ban-confirm-text');
                        
                        if (action === 'ban') {
                            confirmBtn.className = 'btn btn-error';
                            actionIcon.className = 'icon-[tabler--user-x] size-4';
                            confirmText.textContent = 'Ban User';
                        } else {
                            confirmBtn.className = 'btn btn-success';
                            actionIcon.className = 'icon-[tabler--user-check] size-4';
                            confirmText.textContent = 'Unban User';
                        }
                        
                        // Store data for final action
                        window.pendingBanAction = { userId, action };
                        
                        // Show modal
                        const modalTrigger = document.getElementById('ban-confirmation-trigger');
                        if (modalTrigger) {
                            modalTrigger.click();
                        }
                    }
                    
                    // Execute ban/unban action
                    function executeBanAction(userId, action) {
                        triggerNotificationFromData({
                            type: 'info',
                            message: `Processing ${action} action...`
                        });

                        fetch(`/admin/user/${userId}/ban`, {
                            method: 'POST',
                            headers: {
                                'X-CSRF-TOKEN': csrfToken
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                triggerNotificationFromData({
                                    type: 'success',
                                    message: `User ${action === 'ban' ? 'banned' : 'unbanned'} successfully.`
                                });
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                return response.json().then(error => {
                                    throw new Error(error.message || 'Failed to process request.');
                                });
                            }
                        })
                        .catch(error => {
                            triggerNotificationFromData({
                                type: "error",
                                message: "Error: " + error.message
                            });
                        });
                    }

                    // Modal confirmation button
                    const confirmBanBtn = document.getElementById('confirmBanBtn');
                    if (confirmBanBtn) {
                        confirmBanBtn.addEventListener('click', function() {
                            if (window.pendingBanAction) {
                                const { userId, action } = window.pendingBanAction;
                                executeBanAction(userId, action);
                                
                                // Close modal
                                const closeBtn = document.querySelector('[data-overlay="#ban-confirmation-modal"]');
                                if (closeBtn) {
                                    closeBtn.click();
                                }
                            }
                        });
                    }

                    // Event delegation for action buttons
                    if (!window.userActionsListenerAttached) {
                        document.addEventListener('click', function(event) {
                            // Ban/Unban button
                            const banButton = event.target.closest('.ban-user-btn');
                            if (banButton) {
                                confirmBanAction(banButton);
                            }
                        });
                        window.userActionsListenerAttached = true;
                    }
                }, 100)
            })
    </script>
    </th:block>
</body>
</html>