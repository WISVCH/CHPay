<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
  <title>Add Funds</title>
  <th:block layout:fragment="css">
  </th:block>
  <th:block layout:fragment="script">
    <script th:inline="javascript">
      // Wrap in IIFE to prevent redeclaration errors
      (function() {
        window.BALANCE_CONFIG = {
          MAX_BALANCE: parseFloat([[${maxBalance}]]),
          MIN_TOPUP: parseFloat([[${minTopUp}]]),
          TRANSACTION_FEE: parseFloat([[${transactionFee}]]),
          CURRENT_BALANCE: parseFloat([[${currentUser.balance}]])
        };
      })();
    </script>
    <script th:src="@{/js/balance.js}"></script>
  </th:block>
</head>
<body>
<div layout:fragment="main-content">
  <div class="container max-w-4xl mx-auto">

    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-base-content mb-2">Top-up Balance</h1>
      <p class="text-base-content/70 text-lg">
        Add funds to your CHPay account using iDEAL. Your balance will be updated instantly after payment.
      </p>
    </div>

    <!-- Current Balance Card -->
    <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow mb-8">
      <div class="card-body">
        <div class="flex items-center gap-4">
          <div class="avatar avatar-placeholder">
            <div class="bg-primary/20 text-primary size-16 rounded-full">
              <span class="icon-[tabler--wallet] size-8"></span>
            </div>
          </div>
          <div class="flex-1">
            <h2 class="card-title text-2xl">Current Balance</h2>
            <div class="stat-value text-primary text-4xl">
              €<span th:text="${#numbers.formatDecimal(currentUser.balance, 1, 2)}">0.00</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top-up Form Card -->
    <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow">
      <div class="card-body">
        <div class="flex items-center gap-4 mb-6">
          <div class="avatar avatar-placeholder">
            <div class="bg-secondary/20 text-secondary size-12 rounded-full">
              <span class="icon-[tabler--plus] size-6"></span>
            </div>
          </div>
          <div>
            <h3 class="card-title text-xl">Add Funds</h3>
            <p class="text-base-content/70">Choose an amount to add to your balance</p>
          </div>
        </div>

        <form th:action="@{/topup}" method="post" id="topup-form">
          <input type="hidden" id="topupAmount" name="topupAmount"/>
          
          <!-- Amount Selection -->
          <div class="mb-6">
            <label class="label-text text-base font-medium mb-2">Select Amount</label>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 w-full max-sm:grid-cols-1">
              <input class="btn btn-soft w-full" type="radio" name="amountSelection" value="5" aria-label="€5" title="Add €5 to your balance" onchange="handleRadioChange(5)"/>
              <input class="btn btn-soft w-full" type="radio" name="amountSelection" value="10" aria-label="€10" title="Add €10 to your balance" onchange="handleRadioChange(10)"/>
              <input class="btn btn-soft w-full" type="radio" name="amountSelection" value="20" aria-label="€20" title="Add €20 to your balance" onchange="handleRadioChange(20)"/>
              <div class="col-span-1 sm:col-span-2">
                <div class="input" id="customAmountContainer">
                  <label class="label-text my-auto me-3 p-0" for="customAmount">€</label>
                  <input
                    type="number"
                    id="customAmount"
                    class="grow"
                    placeholder="Enter amount"
                    step="0.01"
                    min="0.01"
                    autocomplete="off"
                    data-form-type="other"
                    data-lpignore="true"
                    oninput="handleCustomInput()"
                    onfocus="handleCustomInputFocus()"
                  />
                </div>
                <span class="helper-text" id="customAmountError" style="display: none;"></span>
              </div>
            </div>
          </div>

          <!-- Transaction Fee Overview -->
          <div class="bg-base-200/50 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-2 mb-2">
              <span class="icon-[tabler--info-circle] text-accent size-5"></span>
              <h4 class="font-semibold text-base-content">Payment Summary</h4>
            </div>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-base-content/70">Amount to add:</span>
                <span id="amountToAdd" class="font-medium">€0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-base-content/70">Transaction fee:</span>
                <span class="font-medium">€<span th:text="${transactionFee}">0.00</span></span>
              </div>
              <div class="divider my-2"></div>
              <div class="flex justify-between text-base font-semibold">
                <span>Total to pay:</span>
                <span id="totalToPay" class="text-primary">€0.00</span>
              </div>
            </div>
          </div>

          <!-- Payment Button -->
          <div class="card-actions justify-end">
            <button type="submit" class="btn btn-primary btn-xl w-full sm:w-auto" id="payButton" disabled>
              <span class="icon-[tabler--credit-card] size-5"></span>
              Pay with iDEAL
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</body>
</html>