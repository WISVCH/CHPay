<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title>Payment Request Details</title>
</head>

<body>
<div layout:fragment="breadcrumbs">
    <div class="breadcrumbs">
        <ul>
            <li>
                <a href="/admin/payment-requests">Payment Requests</a>
            </li>
            <li class="breadcrumbs-separator rtl:rotate-180"><span class="icon-[tabler--chevron-right]"></span></li>
            <li aria-current="page" th:text="${paymentRequest.description}">Payment Request Details</li>
        </ul>
    </div>
</div>

<div layout:fragment="main-content">
    <div class="container max-w-4xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-base-content mb-2">Payment Request Details</h1>
            <p class="text-base-content/70 text-lg">Complete payment request information and actions</p>
            </div>

    <!-- Transaction Details Card -->
    <div class="card bg-base-100 shadow-lg border border-base-content/10 hover:shadow-xl transition-shadow mb-8">
        <div class="card-body">
            <div class="flex items-center gap-4 mb-6">
                <div class="avatar avatar-placeholder">
                    <div class="bg-primary/20 text-primary size-12 rounded-full">
                        <span class="icon-[tabler--receipt] size-6"></span>
                    </div>
                </div>
                <div>
                    <h3 class="card-title text-xl">Payment Request Information</h3>
                    <p class="text-base-content/70">Complete payment request details</p>
                </div>
                        </div>

            <div class="space-y-4">

                <!-- Description (for payments) -->
                <div class="py-2 border-b border-base-content/10">
                    <div class="text-base-content/70 text-sm mb-1">Description</div>
                    <div th:text="${paymentRequest.description}">Payment description</div>
                </div>

                <!-- Date -->
                <div class="py-2 border-b border-base-content/10">
                    <div class="text-base-content/70 text-sm mb-1">Creation date</div>
                    <div th:text="${#temporals.format(paymentRequest.createdAt, 'dd MMM yyyy, HH:mm:ss')}">01 Jan 2025, 12:00:00</div>
                    </div>


                <!-- Amount -->
                <div class="py-2 border-b border-base-content/10">
                    <div class="text-base-content/70 text-sm mb-1">Amount</div>
                    <div class="font-mono">
                        <span th:if="${paymentRequest.amount >= 0}"
                              class="text-success"
                              th:text="'€' + ${#numbers.formatDecimal(paymentRequest.amount, 1, 2)}">€0.00</span>
                        <span th:if="${paymentRequest.amount < 0}"
                              class="text-error"
                              th:text="'€' + ${#numbers.formatDecimal(paymentRequest.amount, 1, 2)}">€0.00</span>
                    </div>
                </div>


                <!-- Status -->
                <div class="py-2 border-b border-base-content/10">
                    <div class="text-base-content/70 text-sm mb-1">Status</div>
                    <div>
                        <span th:if="${!paymentRequest.isExpired() && (paymentRequest.fulfilments == 0 || paymentRequest.isMultiUse())}" class="badge badge-soft badge-success badge-sm">Open</span>
                        <span th:if="${paymentRequest.fulfilments > 0 && !paymentRequest.isMultiUse()}" class="badge badge-soft badge-success badge-sm">Fulfilled</span>
                        <span th:if="${paymentRequest.isExpired() && (paymentRequest.isMultiUse() || paymentRequest.fulfilments == 0)}" class="badge badge-soft badge-warning badge-sm">Expired</span>
                    </div>
                </div>

                <!-- Transaction ID -->
                <div class="py-2 border-b border-base-content/10">
                    <div class="text-base-content/70 text-sm mb-1">Payment Request ID</div>
                    <div class="font-mono text-sm" th:text="${paymentRequest.getRequest_id()}">abc-123</div>
                </div>

            </div>

            <!-- Action Buttons -->
            <div class="card-actions justify-end pt-4 border-base-content/10 mt-6">
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <a th:href="@{/admin/payment-request/{id}/transactions(id=${paymentRequest.request_id})}"
                       class="btn btn-primary w-full sm:w-auto">
                        <span class="icon-[tabler--receipt] size-4"></span>
                        View Transactions
                    </a>
                    <a th:href="@{/qr/{id}(id=${paymentRequest.request_id})}"
                       class="btn btn-primary w-full sm:w-auto"
                       th:class="${paymentRequest.isExpired() || (!paymentRequest.isMultiUse() && paymentRequest.fulfilments > 0)} ? 'btn btn-primary w-full sm:w-auto btn-disabled' : 'btn btn-primary w-full sm:w-auto'"
                       th:disabled="${paymentRequest.isExpired() || (!paymentRequest.isMultiUse() && paymentRequest.fulfilments > 0)}">
                        <span class="icon-[tabler--qrcode] size-4"></span>
                        View QR Code
                    </a>
                    <button type="button" 
                            class="btn btn-warning w-full sm:w-auto" 
                            th:disabled="${paymentRequest.isExpired() || (!paymentRequest.isMultiUse() && paymentRequest.fulfilments > 0)}"
                            id="expire-payment-request-btn"
                            th:data-payment-request-id="${paymentRequest.request_id}">
                        <span class="icon-[tabler--clock-x] size-4"></span>
                        <span>Expire payment request</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    </div>
</div>

<!-- Modals -->
<th:block layout:fragment="modals">

    <!-- Hidden trigger for expire confirmation modal -->
    <button type="button" 
            class="hidden" 
            id="expire-confirmation-trigger"
            aria-haspopup="dialog" 
            aria-expanded="false" 
            aria-controls="expire-confirmation-modal" 
            data-overlay="#expire-confirmation-modal">
    </button>


    <!-- Expire Confirmation Modal -->
    <div id="expire-confirmation-modal" 
         class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden" 
         role="dialog" 
         tabindex="-1">
        <div class="modal-dialog overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Confirm Expire Payment Request</h3>
                    <button type="button" 
                            class="btn btn-text btn-circle btn-sm absolute end-3 top-3" 
                            aria-label="Close" 
                            data-overlay="#expire-confirmation-modal">
                        <span class="icon-[tabler--x] size-4"></span>
                    </button>
                </div>
                
                <div class="modal-body">
                    <p class="text-base-content/70">
                        Are you sure you want to expire this payment request? This action cannot be undone.
                    </p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-soft btn-secondary" data-overlay="#expire-confirmation-modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmExpireBtn">
                        <span class="icon-[tabler--clock-x] size-4"></span>
                        Expire Payment Request
                    </button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<!-- Scripts -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        // Payment request management functionality
        window.addEventListener('load', () => {
            const expireBtn = document.getElementById('expire-payment-request-btn');
            const confirmExpireBtn = document.getElementById('confirmExpireBtn');
            
            const paymentRequestId = [[${paymentRequest.getRequest_id()}]];

            // Expire payment request functionality
            if (expireBtn) {
                expireBtn.addEventListener('click', function() {
                    // Show confirmation modal
                    const modalTrigger = document.getElementById('expire-confirmation-trigger');
                    if (modalTrigger) {
                        modalTrigger.click();
                    }
                });
            }

            // Confirm expire action
            if (confirmExpireBtn) {
                confirmExpireBtn.addEventListener('click', function() {
                    // Show processing notification
                    triggerNotificationFromData({
                        type: 'info',
                        message: 'Expiring payment request...'
                    });
                    
                    // Small delay to show the notification, then redirect
                    setTimeout(() => {
                        window.location.href = `/admin/payment-request/${paymentRequestId}/expire`;
                    }, 500);
                });
            }
        });
    </script>
</th:block>
</body>
</html>
