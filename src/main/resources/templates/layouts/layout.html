<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="CHPay" />
    <link rel="manifest" href="/images/site.webmanifest" />
    <link th:href="@{/css/main.css}" rel="stylesheet" />
    <!-- Charts styles - only load when needed -->
    <th:block th:if="${hasCharts}">
        <link th:href="@{/css/apexcharts.css}" rel="stylesheet" />
    </th:block>
    <title layout:title-pattern="$CONTENT_TITLE - CHPay">CHPay</title>
    <th:block layout:fragment="css"></th:block>
</head>

<body class="bg-base-200 min-h-screen">
    <nav class="navbar bg-base-100 max-lg:rounded-b-box max-lg:shadow-sm lg:border-b border-base-content/25 lg:z-1 relative sticky top-0 z-50">
        <button type="button" class="btn btn-text max-lg:btn-square me-2 lg:hidden" aria-haspopup="dialog" aria-expanded="false" aria-controls="with-navbar-sidebar" data-overlay="#with-navbar-sidebar" >
          <span class="icon-[tabler--menu-2] size-5"></span>
        </button>
        <div class="flex flex-1 items-center">
          <a class="link text-base-content link-neutral text-xl font-semibold no-underline flex items-center" href="/">
              <picture class="w-12">
                  <source th:srcset="@{/images/ch_logo_indigo.svg}"  media="(prefers-color-scheme: light)"/>
                  <source th:srcset="@{/images/ch_logo_white.svg}"  media="(prefers-color-scheme: dark)"/>
                  <img th:src="@{/images/ch_logo_indigo.svg}" alt="CH logo"/>
              </picture>
              <span class="ms-1">CHPay</span>
              <span class="badge badge-soft badge-primary rounded-full -mb-0.5 ms-3">Beta</span>
          </a>
        </div>
                   <div class="navbar-end flex items-center gap-4">
                     <!-- System Freeze Status Indicator -->
                     <div th:if="${systemFrozen}" class="flex items-center gap-2">
                       <div class="status status-warning animate-pulse"></div>
                       <span class="text-warning text-sm font-medium">System Frozen</span>
                     </div>

                     <!-- Ban Status Indicator -->
                     <div th:if="${currentUser!=null and currentUser.getBanned()}" class="flex items-center gap-2">
                       <div class="status status-error animate-bounce"></div>
                       <span class="text-error text-sm font-medium">This user is banned</span>
                     </div>

                     <div class="dropdown relative inline-flex [--auto-close:inside] [--offset:8] [--placement:bottom-end]">
             <button id="dropdown-avatar" type="button" class="dropdown-toggle flex items-center" aria-haspopup="menu" aria-expanded="false" aria-label="User Menu">
               <div class="avatar avatar-placeholder">
                 <div class="bg-accent text-accent-content size-9.5 rounded-full">
                   <span class="text-sm uppercase" th:text="${#strings.substring(currentUser.name, 0, 2)}">U</span>
                 </div>
               </div>
             </button>
             <ul class="dropdown-menu dropdown-open:opacity-100 hidden min-w-60" role="menu" aria-orientation="vertical" aria-labelledby="dropdown-avatar">
               <li class="dropdown-header gap-2">
                 <div class="avatar avatar-placeholder">
                   <div class="bg-accent text-accent-content w-10 rounded-full">
                     <span class="text-sm uppercase" th:text="${#strings.substring(currentUser.name, 0, 2)}">U</span>
                   </div>
                 </div>
                 <div>
                   <h6 class="text-base-content text-base font-semibold" th:text="${currentUser.name}">User</h6>
                   <small class="text-base-content/50" th:text="${currentUser.email}">user@example.com</small>
                 </div>
               </li>
                 <form th:action="@{/logout}" method="post" style="margin:0; padding:0; display:block;" class="text-error hover:bg-error/10 w-full">
                   <button type="submit" class="btn btn-error btn-soft btn-block">
                     <span class="icon-[tabler--logout] size-5 flex-shrink-0"></span>
                     Sign out
                   </button>
                 </form>
             </ul>
           </div>
         </div>
      </nav>

      <!-- Main Layout Container -->
      <div class="flex">
        <!-- Sidebar -->
        <aside id="with-navbar-sidebar" class="overlay [--body-scroll:true] border-base-content/20 overlay-open:translate-x-0 drawer drawer-start lg:overlay-layout-open:translate-x-0 hidden w-64 border-e [--auto-close:lg] [--is-layout-affect:true] lg:static lg:block lg:translate-x-0 lg:h-[calc(100vh-4rem)] lg:sticky lg:top-16 lg:z-40" role="dialog" tabindex="-1">
          <div class="drawer-body px-2 pt-4 lg:pt-6">
            <ul class="menu p-0">
              <!-- Home -->
              <li>
                  <a href="/index" th:class="${urlPage == null} ? 'menu-active' : ''">
                      <span class="icon-[tabler--home] size-5"></span>
                      Home
                  </a>
              </li>

             <!-- Add Funds -->
             <li th:class="${currentUser!=null and currentUser.getBanned()} ? 'menu-disabled' : ''">
                 <a href="/topup" th:class="${urlPage == 'topup'} ? 'menu-active' : ''">
                     <span class="icon-[tabler--plus] size-5"></span>
                     Add Funds
                 </a>
             </li>

              <!-- Transactions -->
              <li>
                  <a href="/transactions" th:class="${urlPage == 'transactions'} ? 'menu-active' : ''">
                      <span class="icon-[tabler--receipt] size-5"></span>
                      Transactions
                  </a>
              </li>

              <!-- Admin Section (if user is admin) -->
              <li th:if="${isAdmin}" class="space-y-0.5">
                  <a class="collapse-toggle collapse-open:bg-warning/10 text-warning hover:bg-warning/10"
                     th:class="${urlPage == 'admin' or urlPage == 'createPaymentRequest' or urlPage == 'adminTransactions' or urlPage == 'adminUsers' or urlPage == 'systemSettings' or urlPage == 'adminLogs'} ? 'collapse-toggle collapse-open collapse-open:bg-warning/10 text-warning hover:bg-warning/10' : 'collapse-toggle collapse-open:bg-warning/10 text-warning hover:bg-warning/10'"
                     id="menu-admin" data-collapse="#menu-admin-collapse">
                      <span class="icon-[tabler--shield] size-5"></span>
                      Admin
                      <span class="icon-[tabler--chevron-down] collapse-open:rotate-180 size-4 transition-all duration-300"></span>
                  </a>
                  <ul id="menu-admin-collapse"
                      th:class="${urlPage == 'admin' or urlPage == 'createPaymentRequest' or urlPage == 'adminTransactions' or urlPage == 'adminUsers' or urlPage == 'systemSettings' or urlPage == 'adminLogs'} ? 'collapse collapse-open w-auto space-y-0.5 overflow-hidden transition-[height] duration-300' : 'collapse w-auto space-y-0.5 overflow-hidden transition-[height] duration-300 hidden'"
                      aria-labelledby="menu-admin">
                      <li>
                          <a href="/admin" th:class="${urlPage == 'admin'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--dashboard] size-5"></span>
                              Dashboard
                          </a>
                      </li>
                      <li>
                          <a href="/admin/createPaymentRequest" th:class="${urlPage == 'createPaymentRequest'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--qrcode] size-5"></span>
                              Payment Request
                          </a>
                      </li>
                      <li>
                          <a href="/admin/transactions" th:class="${urlPage == 'adminTransactions'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--receipt] size-5"></span>
                              Transactions
                          </a>
                      </li>
                      <li>
                          <a href="/admin/users" th:class="${urlPage == 'adminUsers'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--users] size-5"></span>
                              Users
                          </a>
                      </li>
                      <li>
                          <a href="/admin/settings" th:class="${urlPage == 'systemSettings'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--settings] size-5"></span>
                              System Settings
                          </a>
                      </li>
                      <li>
                          <a href="/admin/log" th:class="${urlPage == 'adminLogs'} ? 'menu-active' : ''">
                              <span class="icon-[tabler--file-text] size-5"></span>
                              Error Log
                          </a>
                      </li>
                  </ul>
              </li>
            </ul>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 lg:overlay-layout-open:ps-64 min-h-[calc(100vh-4rem)] bg-base-200 transition-all duration-300 flex flex-col">
            <!-- Breadcrumbs -->
            <div class="px-6 pt-6" layout:fragment="breadcrumbs">
                <!-- Breadcrumbs go here -->
            </div>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <div th:class="${layoutWide} ? 'max-w-full mx-auto px-4 sm:px-6 lg:px-8' : 'max-w-4xl mx-auto'">
                    <div layout:fragment="main-content">
                        <!-- Page content goes here -->
                    </div>
                </div>
            </main>

            <!-- Spacer to push footer to bottom -->
            <div class="flex-grow"></div>

             <!-- Footer -->
             <footer class="bg-base-100 border-t border-base-content/10 mt-auto">
                 <div class="px-6 py-4">
                     <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                         <p class="text-sm text-base-content/60">
                             Copyright © W.I.S.V. 'Christiaan Huygens' 2025
                         </p>
                         <div class="flex items-center gap-4 text-sm text-base-content/60">
                             <a href="https://ch.tudelft.nl/privacy-statement/" class="hover:text-primary" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
                         </div>
                     </div>
                 </div>
             </footer>
        </div>
      </div>

      <script th:src="@{/js/jquery.min.js}"></script>
      <!-- DataTables scripts - only load when needed -->
      <th:block th:if="${hasDataTable}">
          <script th:src="@{/js/dataTables.min.js}"></script>
      </th:block>
      <!-- Charts scripts - only load when needed -->
      <th:block th:if="${hasCharts}">
          <script th:src="@{/js/apexcharts.min.js}"></script>
          <script th:src="@{/js/lodash.min.js}"></script>
          <script th:src="@{/js/helper-apexcharts.js}"></script>
      </th:block>
      <script th:src="@{/js/flyonui.js}"></script>

    <!-- Modals Fragment -->
    <th:block layout:fragment="modals"></th:block>

    <!-- Notifications -->
    <div th:replace="~{fragments/notifications :: notifications}"></div>

    <!-- Additional scripts from pages -->
    <th:block layout:fragment="script"></th:block>
</body>
</html>
